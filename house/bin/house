#!/usr/bin/env ruby
require 'yaml'
require 'forwardable'

class HouseRhyme
  def say(preamble, lines)
    stanzas.say(preamble, lines)
  end

  private

  def stanzas
    Stanzas.new
  end
end

class Stanzas
  attr_accessor :said

  def initialize(said=String.new)
  end

  def say(preamble, lines)
    lines.each do |stanza|
      StanzaPresenter.new(preamble,stanza_builder(stanza)).say
    end
  end

  private

  def stanza_builder(stanza_part)
    self.said = Stanza.new(stanza_part).say + said
  end

  def said
    if @said
      ' ' + @said
    else
      @said = "."
    end
  end
end

class Stanza
  attr_accessor :stanza_part, :linking_article
  def initialize(stanza_part, linking_article=ArticleThe.new)
    self.stanza_part = stanza_part
    self.linking_article = linking_article
  end

  def say
    linking_article.to_s + ' ' + stanza_part.actor + ' that ' + stanza_part.action
  end
end

class StanzaPresenter
  attr_accessor :preamble, :stanza, :output
  def initialize(preamble, stanza, output=StdoutOutput.new)
    self.preamble = preamble
    self.stanza   = stanza
    self.output   = output
  end

  def say
    output.line preamble, stanza
    output.pause
  end
end

class StdoutOutput
  def line(*parts)
    puts parts.join(' ').strip
  end

  def pause
    puts ""
  end
end

class ArticleThe
  def to_str
    'the'
  end
  alias_method :to_s, :to_str
end

class Preamble
  def to_str
    'This is'
  end
  alias_method :to_s, :to_str
end

class Lines
  attr_reader :collection, :actions, :actors
  def initialize(actions, actors)
    merge_actors_and_actions(actors, actions)
  end

  def each(&block)
    collection.each(&block)
  end

  def merge_actors_and_actions(actors, actions)
    actors.each_with_index do |actor, index|
      collection << Line.new(actor, actions[index])
    end
  end

  def collection
    @collection ||= []
  end
end

class Line
  attr_accessor :actor, :action
  def initialize(actor, action)
    self.actor = actor
    self.action = action
  end
end

class YamlSource
  def self.open(directory,name)
    YAML::load(File.open("./data/#{directory}/#{name}.yml"))
  end
end

class SongElements
  extend Forwardable
  attr_accessor :collection

  def_delegators :collection, :each, :[], :each_with_index

  def initialize(name, source=YamlSource)
    source.open(self.class.to_s.downcase, name).each do |line|
      collection << line
    end
  end

  def collection
    @collection ||= []
  end

  def shuffle!
    collection.shuffle!
    self
  end

  def begin_with(element)
    collection.delete(element)
    collection.unshift(element)
  end
end

class Actors < SongElements; end

class Actions < SongElements; end

actors = Actors.new('jack_built')
actions = Actions.new('jack_built')
actors = actors.shuffle!
actions = actions.shuffle!
actors.begin_with('house')
actions.begin_with('Jack built')
lines = Lines.new(actions, actors)
HouseRhyme.new.say(Preamble.new, lines)
